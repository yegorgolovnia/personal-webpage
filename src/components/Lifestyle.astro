---
import { getLatestActivity } from "../lib/strava";

// Fetch Strava Data
const stravaActivities = await getLatestActivity();
const activities = Array.isArray(stravaActivities) ? stravaActivities : [];

// We want to show 5 items. With 90deg geometry, 360deg covers 4 items.
// Item 5 will effectively overlap Item 1 (at 360deg).
// This is acceptable for a "simulated tape" effect.
// Ensure we have enough data.
const displayActivities = [...activities];
while (displayActivities.length < 5) {
    displayActivities.push({ type: "Empty", id: "empty" });
}
const finalActivities = displayActivities.slice(0, 5);

// Spotify Data
const playlists = [
    {
        month: "Feb '26",
        url: "https://open.spotify.com/playlist/01QytP6FU4AvHMPM9uzFIZ",
    },
    {
        month: "Jan '26",
        url: "https://open.spotify.com/playlist/3CVIbEDvJ93BTa2GX393PD?si=b8171c174727404e",
    },
    {
        month: "Dec '25",
        url: "https://open.spotify.com/playlist/0h2wa8isRovLhuDyvJ9zzv?si=0348503b85464872",
    },
    {
        month: "Nov '25",
        url: "https://open.spotify.com/playlist/6SzWlZxv8UN46aLpX5RG9x?si=a7c3b25743194c83",
    },
    {
        month: "Oct '25",
        url: "https://open.spotify.com/playlist/1P3Iu18FrIeXAMMqUsLB0a?si=ce80fe238b2344e4",
    },
];

function formatDuration(seconds: number) {
    if (!seconds) return "-";
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    if (h > 0) return `${h}h ${m}m`;
    return `${m}m ${s}s`;
}

function formatPace(time: number, distance: number, isSwim: boolean = false) {
    if (!time || !distance) return "-";
    let pace;
    if (isSwim) {
        pace = time / 60 / (distance / 100);
    } else {
        pace = time / 60 / (distance / 1000);
    }

    const paceMins = Math.floor(pace);
    const paceSecs = Math.round((pace - paceMins) * 60);
    return `${paceMins}:${paceSecs.toString().padStart(2, "0")}`;
}

function getActivityStats(activity: any) {
    if (activity.type === "Empty")
        return { label1: "-", val1: "-", label2: "-", val2: "-" };

    const type = activity.type;
    const isRun = type === "Run" || type === "Walk" || type === "Hike";
    const isRide = type === "Ride" || type === "VirtualRide";
    const isSwim = type === "Swim";

    let burn = Math.round(activity.kilojoules || activity.calories || 0);
    let label2 = "Burn";
    let val2 = `${burn}kcal`;

    if (burn === 0) {
        if (activity.total_elevation_gain > 0) {
            label2 = "Elev";
            val2 = `${Math.round(activity.total_elevation_gain)}m`;
        } else {
            label2 = "Rest";
            val2 = "-";
        }
    }

    let stats = {
        label1: "Time",
        val1: formatDuration(activity.moving_time),
        label2: label2,
        val2: val2,
    };

    if (isRun) {
        stats = {
            label1: "Dist",
            val1: `${(activity.distance / 1000).toFixed(2)}km`,
            label2: "Pace",
            val2: `${formatPace(activity.moving_time, activity.distance)}/km`,
        };
    } else if (isRide) {
        stats = {
            label1: "Dist",
            val1: `${(activity.distance / 1000).toFixed(2)}km`,
            label2: "Time",
            val2: formatDuration(activity.moving_time),
        };
    } else if (isSwim) {
        stats = {
            label1: "Dist",
            val1: `${activity.distance.toFixed(0)}m`,
            label2: "Pace",
            val2: `${formatPace(activity.moving_time, activity.distance, true)}/100m`,
        };
    }

    return stats;
}
---

<section id="lifestyle">
    <div class="header">
        <h2>Lifestyle</h2>
        <span class="mono">/api_streams</span>
    </div>

    <div class="grid">
        <!-- Spotify Cube (Interactive Scroll) -->
        <div class="prism-scene spotify-scene">
            <div class="prism cube">
                {
                    playlists.map((playlist, index) => (
                        <a
                            href={playlist.url}
                            target="_blank"
                            rel="noopener noreferrer"
                            class={`face spotify face-${index}`}
                            style={`transform: rotateX(${-index * 90}deg) translateZ(110px)`}
                        >
                            <div class="icon-header">
                                <svg
                                    width="24"
                                    height="24"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <path d="M9 18V5l12-2v13" />
                                    <circle cx="6" cy="18" r="3" />
                                    <circle cx="18" cy="16" r="3" />
                                </svg>
                                <span class="mono">Spotify / Matches</span>
                            </div>
                            <div class="content">
                                <div class="art">
                                    <div class="disc" />
                                </div>
                                <div class="info">
                                    <strong>{playlist.month}</strong>
                                    <br />
                                    <span class="artist mono">
                                        Playlist by Yegor
                                    </span>
                                </div>
                            </div>
                            <div class="status mono">
                                <span class="pulse" /> Listening...
                            </div>
                        </a>
                    ))
                }
            </div>
            <div class="hint mono">Scroll to rotate â‡µ</div>
        </div>

        <!-- Strava Cube (Auto Rotate) -->
        <div class="prism-scene strava-scene">
            <div class="prism cube">
                {
                    finalActivities.map((activity, index) => (
                        <a
                            href={
                                activity.id !== "empty"
                                    ? `https://www.strava.com/activities/${activity.id}`
                                    : "#"
                            }
                            target="_blank"
                            rel="noopener noreferrer"
                            class={`face strava face-${index} ${activity.type === "Empty" ? "empty" : ""}`}
                            style={`transform: rotateX(${-index * 90}deg) translateZ(110px)`}
                        >
                            {activity.type !== "Empty" ? (
                                <>
                                    <div class="icon-header">
                                        <svg
                                            width="24"
                                            height="24"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                        >
                                            <circle cx="12" cy="12" r="10" />
                                            <polyline points="12 6 12 12 16 14" />
                                        </svg>
                                        <span class="mono">
                                            Strava / Activity {index + 1}
                                        </span>
                                    </div>
                                    <div class="content">
                                        <div class="activity-meta">
                                            <span class="type-large">
                                                {activity.type}
                                            </span>
                                            <span class="date mono">
                                                {new Date(
                                                    activity.start_date,
                                                ).toLocaleDateString(
                                                    undefined,
                                                    {
                                                        month: "short",
                                                        day: "numeric",
                                                    },
                                                )}
                                            </span>
                                        </div>
                                        <div class="stat-row">
                                            <div>
                                                <span class="label mono">
                                                    {
                                                        getActivityStats(
                                                            activity,
                                                        ).label1
                                                    }
                                                </span>
                                                <div class="val">
                                                    {
                                                        getActivityStats(
                                                            activity,
                                                        ).val1
                                                    }
                                                </div>
                                            </div>
                                            <div>
                                                <span class="label mono">
                                                    {
                                                        getActivityStats(
                                                            activity,
                                                        ).label2
                                                    }
                                                </span>
                                                <div class="val">
                                                    {
                                                        getActivityStats(
                                                            activity,
                                                        ).val2
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="status mono">
                                        <span class="pulse" /> Recent
                                    </div>
                                </>
                            ) : (
                                <div class="center-msg mono">No Data</div>
                            )}
                        </a>
                    ))
                }
            </div>
            <div class="hint mono">Syncing...</div>
        </div>
    </div>
</section>

<style>
    #lifestyle {
        padding: 4rem 0;
    }
    .header {
        display: flex;
        align-items: baseline;
        gap: 1rem;
        margin-bottom: 3rem;
        border-bottom: 1px solid var(--color-accent-subtle);
        padding-bottom: 1rem;
    }
    .mono {
        font-family: var(--font-mono);
        color: var(--color-text-muted);
        font-size: 0.85rem;
    }
    .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 4rem;
        row-gap: 6rem;
    }

    .prism-scene {
        perspective: 1000px;
        height: 220px;
        position: relative;
    }

    .hint {
        position: absolute;
        bottom: -30px;
        width: 100%;
        text-align: center;
        font-size: 0.7rem;
        opacity: 0.5;
    }

    .prism {
        width: 100%;
        height: 100%;
        position: relative;
        transform-style: preserve-3d;
        transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
        /* 
           CUBE GEOMETRY: Height 220px. 
           Center of rotation should be in the middle of the cube.
           Radius (apothem) of a cube is Height/2 = 110px.
           So translation Z of faces is 110px.
           Transform Origin Z should be -110px (pushing the pivot point back to the center).
        */
        transform-origin: 50% 50% -110px;
    }

    .face {
        position: absolute;
        width: 100%;
        height: 100%;
        background: #0a0a0a;
        border: 1px solid var(--color-accent-subtle);
        border-radius: 12px;
        padding: 1.5rem;
        box-sizing: border-box;
        text-decoration: none;
        color: inherit;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        /* Using 90deg steps, backface visibility is beneficial for performance and doesn't hurt visuals */
        backface-visibility: hidden;
        box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.5);
    }

    /* Individual Face transforms are handled inline for scalability with N items */

    /* Content Styling */
    .icon-header {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        color: var(--color-text);
        margin-bottom: 1rem;
    }
    .content {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .activity-meta {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 1rem;
    }
    .type-large {
        font-size: 1.5rem;
        font-weight: 700;
        color: #fc4c02;
    }

    .stat-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }
    .label {
        font-size: 0.7rem;
        display: block;
        margin-bottom: 0.2rem;
        color: var(--color-text-muted);
    }
    .val {
        font-size: 1.2rem;
        font-weight: 500;
    }

    .spotify .content {
        flex-direction: row;
        align-items: center;
    }
    .art {
        width: 50px;
        height: 50px;
        background: #333;
        border-radius: 4px;
        position: relative;
        overflow: hidden;
        margin-right: 1rem;
    }
    .disc {
        width: 100%;
        height: 100%;
        background: conic-gradient(from 0deg, #333, #666);
        border-radius: 50%;
        animation: spin 4s linear infinite;
    }
    @keyframes spin {
        100% {
            transform: rotate(360deg);
        }
    }

    .status {
        margin-top: auto;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.75rem;
    }
    .pulse {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    .spotify .pulse {
        background: #1db954;
        box-shadow: 0 0 5px #1db954;
    }
    .strava .pulse {
        background: #fc4c02;
        box-shadow: 0 0 5px #fc4c02;
    }

    .artist {
        opacity: 0.7;
        font-size: 0.8rem;
    }
    .center-msg {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        opacity: 0.5;
    }

    @keyframes pulse {
        0% {
            opacity: 1;
        }
        50% {
            opacity: 0.5;
        }
        100% {
            opacity: 1;
        }
    }

    @media (min-width: 768px) {
        .grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem;
        }
    }
</style>

<script>
    // --- SPOTIFY INTERACTION (Debounced Step-Scroll) ---
    const spotifyScene = document.querySelector(".spotify-scene");
    if (spotifyScene) {
        const prism = spotifyScene.querySelector(".prism") as HTMLElement;
        let spotifyRotation = 0;
        let isAnimating = false; // Lock to force 1-step-at-time

        spotifyScene.addEventListener(
            "wheel",
            (e: WheelEvent) => {
                e.preventDefault();

                if (isAnimating) return; // Ignore input during animation

                // Threshold checking? Maybe not needed if we lock immediately.
                // Just detection of direction.
                const direction = e.deltaY > 0 ? -1 : 1;

                isAnimating = true;
                spotifyRotation += direction * 90; // Snap to next 90deg face

                prism.style.transform = `rotateX(${spotifyRotation}deg)`;

                // Unlock after transition completes
                setTimeout(() => {
                    isAnimating = false;
                }, 600); // 600ms matches CSS transition duration
            },
            { passive: false },
        );
    }

    // --- STRAVA INTERACTION (Auto Rotate) ---
    const stravaScene = document.querySelector(".strava-scene");
    if (stravaScene) {
        const prism = stravaScene.querySelector(".prism") as HTMLElement;
        let stravaRotation = 0;

        setInterval(() => {
            stravaRotation -= 90; // Rotate to next face (negative goes 'down')
            prism.style.transform = `rotateX(${stravaRotation}deg)`;
        }, 3500); // 3.5s slideshow
    }
</script>
